<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Zilarte</title>
    <style>
      :root {
        color-scheme: light;
      }

      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        min-height: 100vh;
        background: #f3f4f6;
        color: #111;
        padding: 1.5rem 1rem 2rem;
        box-sizing: border-box;
      }

      main {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
      }

      .preview-panel {
        background: #fff;
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .preview-panel h2 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #111;
      }

      .preview-media {
        position: relative;
        width: 100%;
        border-radius: 12px;
        background: #fff;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.04);
        overflow: hidden;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .preview-media img,
      .preview-media canvas {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .preview-media img {
        background: #f9fafb;
      }

      .preview-media canvas.is-hidden {
        display: none !important;
      }

      .placeholder-content {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        color: #6b7280;
        text-align: center;
        padding: 1.5rem;
      }

      .upload-button {
        border: none;
        background: #2563eb;
        color: #fff;
        padding: 0.85rem 1.5rem;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.95rem;
        box-shadow: 0 12px 25px rgba(37, 99, 235, 0.25);
      }

      .upload-button:hover {
        background: #1d4ed8;
      }

      .back-button {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        border: none;
        background: rgba(15, 23, 42, 0.65);
        color: #fff;
        border-radius: 999px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition: opacity 0.15s ease;
      }

      .back-button:hover {
        opacity: 0.9;
      }

      .is-hidden {
        display: none !important;
      }

      aside {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 1.5rem;
        box-sizing: border-box;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
      }

      fieldset {
        border: none;
        margin: 0 0 1rem;
        padding: 0;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      input[type="range"] {
        width: 100%;
      }

      .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
      }

      button {
        border: none;
        background: #2563eb;
        color: #fff;
        padding: 0.6rem 1.25rem;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.15s ease;
      }

      button:hover {
        background: #1d4ed8;
      }

      button:active {
        transform: translateY(1px);
      }

      .status {
        margin-top: 1.5rem;
        font-size: 0.85rem;
        color: #666;
        line-height: 1.5;
      }

      .status strong {
        color: #111;
      }
    </style>
  </head>
    <body>
    <main>
      <article class="preview-panel">
        <h2 id="preview-heading">Imagen original</h2>
        <div class="preview-media">
          <button id="back-button" class="back-button is-hidden" aria-label="Volver a seleccionar imagen">
            ‚Üê
          </button>
          <img
            id="preview-image"
            alt="Vista previa de la imagen seleccionada"
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-size='24'%3ESin imagen%3C/text%3E%3C/svg%3E"
          />
          <canvas id="result" width="1000" height="1000" class="is-hidden"></canvas>
          <div id="placeholder-content" class="placeholder-content">
            <button id="placeholder-upload" class="upload-button" type="button">Subir imagen</button>
          </div>
        </div>
      </article>
    </main>
    <aside>
      <fieldset>
        <label>
          Clavos
          <input id="pegs" type="range" min="80" max="400" step="10" value="300" />
          <span id="pegs-value">300</span>
        </label>
        <label>
          Lineas
          <input id="lines" type="range" min="1000" max="4000" step="100" value="3000" />
          <span id="lines-value">3000</span>
        </label>
        <label>
          Opacidad
          <input id="opacity" type="range" min="0.01" max="1.0" step="0.01" value="1.0" />
          <span id="opacity-value">1.0</span>
        </label>
        <label>
          Grosor
          <input id="thickness" type="range" min="0.01" max="0.1" step="0.001" value="0.02" />
          <span id="thickness-value">0.25</span>
        </label>
        <label>
          Zoom
          <input id="zoom" type="range" min="1" max="8" step="0.1" value="1" />
          <span id="zoom-value">1</span>
        </label>
        <label>
          Desplazamiento X
          <input id="zoom-offset-x" type="range" min="-1" max="1" step="0.01" value="0" />
          <span id="zoom-offset-x-value">0</span>
        </label>
        <label>
          Desplazamiento Y
          <input id="zoom-offset-y" type="range" min="-1" max="1" step="0.01" value="0" />
          <span id="zoom-offset-y-value">0</span>
        </label>
        <label>
          Forma
          <select id="shape">
            <option value="circle" selected>Circulo</option>
            <option value="rectangle">Rectangulo</option>
          </select>
        </label>
      </fieldset>

      <div class="actions">
        <button id="generate">Generar</button>
        <button id="download" type="button">Descargar instrucciones</button>
      </div>

      <div class="status">
        <div><strong>Clavos:</strong> <span id="status-pegs">-</span></div>
        <div><strong>Segmentos:</strong> <span id="status-segments">-</span></div>
        <div><strong>Error promedio:</strong> <span id="status-error">-</span></div>
      </div>
    </aside>

    <script src="./threadingSingle.js"></script>
    <script type="text/javascript">
      const elements = {
        pegs: document.getElementById("pegs"),
        lines: document.getElementById("lines"),
        opacity: document.getElementById("opacity"),
        thickness: document.getElementById("thickness"),
        zoom: document.getElementById("zoom"),
        zoomOffsetX: document.getElementById("zoom-offset-x"),
        zoomOffsetY: document.getElementById("zoom-offset-y"),
        shape: document.getElementById("shape"),
        generate: document.getElementById("generate"),
        download: document.getElementById("download"),
        previewImage: document.getElementById("preview-image"),
        placeholderContent: document.getElementById("placeholder-content"),
        placeholderUpload: document.getElementById("placeholder-upload"),
        backButton: document.getElementById("back-button"),
        previewHeading: document.getElementById("preview-heading"),
        canvas: document.getElementById("result"),
        statusPegs: document.getElementById("status-pegs"),
        statusSegments: document.getElementById("status-segments"),
        statusError: document.getElementById("status-error"),
        pegsValue: document.getElementById("pegs-value"),
        linesValue: document.getElementById("lines-value"),
        opacityValue: document.getElementById("opacity-value"),
        thicknessValue: document.getElementById("thickness-value"),
        zoomValue: document.getElementById("zoom-value"),
        zoomOffsetXValue: document.getElementById("zoom-offset-x-value"),
        zoomOffsetYValue: document.getElementById("zoom-offset-y-value"),
      };

      const ctx = elements.canvas.getContext("2d");
      let currentImage = null;
      let currentThreading = null;
      let rafId = null;
      let previewObjectUrl = null;

      function showOriginalView() {
        elements.previewHeading.textContent = "Imagen original";
        elements.previewImage.classList.remove("is-hidden");
        elements.canvas.classList.add("is-hidden");
        elements.placeholderContent.classList.toggle("is-hidden", Boolean(currentImage));
        elements.backButton.classList.add("is-hidden");
      }

      function showResultView() {
        elements.previewHeading.textContent = "Resultado con hilos";
        elements.previewImage.classList.add("is-hidden");
        elements.canvas.classList.remove("is-hidden");
        elements.placeholderContent.classList.add("is-hidden");
        elements.backButton.classList.remove("is-hidden");
      }

      showOriginalView();

      const plotter = {
        get size() {
          return { width: elements.canvas.width, height: elements.canvas.height };
        },
        drawBrokenLine(points, color, opacity, operation, thickness) {
          ThreadingSingle.applyCanvasCompositing(ctx, color, opacity, operation);
          ctx.lineWidth = thickness;
          ctx.lineCap = "round";

          for (let i = 0; i < points.length-1; i++) {
            ctx.beginPath();
            ctx.moveTo(points[i].x, points[i].y);
            ctx.lineTo(points[i+1].x, points[i+1].y);
            ctx.stroke();
          }
          
          ThreadingSingle.resetCanvasCompositing(ctx);
        },
        drawPoints(points, color, radius) {
          ctx.fillStyle = color;
          for (const point of points) {
            ctx.beginPath();
            ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
            ctx.fill();
          }
        },
      };

      function handleImageSelection(file) {
        if (!file) return;

        if (previewObjectUrl) {
          URL.revokeObjectURL(previewObjectUrl);
          previewObjectUrl = null;
        }

        const url = URL.createObjectURL(file);
        previewObjectUrl = url;
        const img = new Image();
        img.onload = () => {
          currentImage = img;
          elements.previewImage.src = url;
          ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
          ctx.drawImage(img, 0, 0, elements.canvas.width, elements.canvas.height);
          showOriginalView();
          elements.placeholderContent.classList.add("is-hidden");
          elements.backButton.classList.remove("is-hidden");
        };
        img.src = url;
      }

      elements.placeholderUpload.addEventListener("click", () => {
        const tempInput = document.createElement("input");
        tempInput.type = "file";
        tempInput.accept = "image/*";
        tempInput.style.display = "none";
        document.body.appendChild(tempInput);
        tempInput.addEventListener("change", (event) => {
          const file = event.target.files[0];
          handleImageSelection(file);
          document.body.removeChild(tempInput);
        });
        tempInput.click();
      });

      elements.backButton.addEventListener("click", () => {
        currentImage = null;
        if (previewObjectUrl) {
          URL.revokeObjectURL(previewObjectUrl);
          previewObjectUrl = null;
        }
        elements.previewImage.src =
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-size='24'%3ESin imagen%3C/text%3E%3C/svg%3E";
        ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
        showOriginalView();
        elements.placeholderContent.classList.remove("is-hidden");
        elements.backButton.classList.add("is-hidden");
      });

      function bindRange(range, output) {
        range.addEventListener("input", () => {
          output.textContent = range.value;
        });
        output.textContent = range.value;
      }

      bindRange(elements.pegs, elements.pegsValue);
      bindRange(elements.lines, elements.linesValue);
      bindRange(elements.opacity, elements.opacityValue);
      bindRange(elements.thickness, elements.thicknessValue);
      bindRange(elements.zoom, elements.zoomValue);
      bindRange(elements.zoomOffsetX, elements.zoomOffsetXValue);
      bindRange(elements.zoomOffsetY, elements.zoomOffsetYValue);

      function updateStatus() {
        if (!currentThreading) {
          elements.statusPegs.textContent = "-";
          elements.statusSegments.textContent = "-";
          elements.statusError.textContent = "-";
          return;
        }

        elements.statusPegs.textContent = currentThreading.pegs.length;
        elements.statusSegments.textContent = currentThreading.nbSegments;
        elements.statusError.textContent = `${currentThreading.error.average} / ${currentThreading.error.meanSquare}`;
      }

      function drawLoop() {
        if (!currentThreading) return;

        const dirty = currentThreading.computeNextSegments(20);
        if (dirty) {
          ctx.fillStyle = currentThreading.parameters.invertColors ? "#000" : "#fff";
          ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);

          if (currentThreading.parameters.displayPegs) {
            currentThreading.drawPegs(plotter);
          }

          currentThreading.drawThread(plotter, 0);
          updateStatus();
        }

        rafId = requestAnimationFrame(drawLoop);
      }

      elements.generate.addEventListener("click", () => {
        if (!currentImage) {
          alert("Selecciona una imagen primero.");
          return;
        }

        if (rafId !== null) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }


        showResultView();
        currentThreading = new ThreadingSingle(currentImage, {
          shape: elements.shape.value,
          pegsCount: parseInt(elements.pegs.value, 10),
          nbLines: parseInt(elements.lines.value, 10),
          lineOpacity: parseFloat(elements.opacity.value),
          lineThickness: parseFloat(elements.thickness.value),
          zoom: parseFloat(elements.zoom.value),
          zoomOffsetX: parseFloat(elements.zoomOffsetX.value),
          zoomOffsetY: parseFloat(elements.zoomOffsetY.value),
        });

        updateStatus();
        drawLoop();
      });

      elements.download.addEventListener("click", () => {
        if (!currentThreading) {
          alert("Genera un arte de hilos primero.");
          return;
        }

        const blob = new Blob([currentThreading.instructions], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "instrucciones-arte-hilos.txt";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>

